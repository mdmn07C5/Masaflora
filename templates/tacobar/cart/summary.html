{% extends "../base.html" %}
{% load static %}
{% block  title %}
    Shopping Cart Summary
{% endblock title %}
{% block content %}
    <main class="pt-5">
        <div class="container">
            <h1 class="h5">Shopping Cart</h1>
            {% for item in cart %}
            {% with menuitem=item.menuitem %}
            <div data-index="{{ menuitem.id }}", class="row mb-4 border menu-item">
                <div class="col-md-3 col-lg-2 order-md-first bg-light">
                    <img class="img-fluid mx-auto d-block" width="120px" alt="Responsive image" src="{{ menuitem.image.url }}">
                </div>

                <div class="col-md-9 col-lg-10 ps-md-3 ps-lg-10">
                    <a href="{{ menuitem.get_absolute_url }}" class="test-decoration-none text-reset">
                        <h1 class="h5 pt-2">{{ menuitem.name }}</h1>
                    </a>
                </div>

                <div class="border">
                    <div class="col border-bottom">
                        <div class="row p-3">
                            <div class="col-6">Amount:
                                <div id="{{ menuitem.id }}-qty">
                                    {{ item.qty }}
                                </div>
                            </div>
                            <dir class="col-6 text-end"><span class="h6 fw-bold">${{ item.total_price }}</span></dir>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="row p-3">
                        <div class="col-12">
                            <label for="select">Qty</label>
                            <select id="select"{{ item.qty }}>
                                <option selected value=1>1</option>
                                {% for i in '2345' %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
                            </select>
                            <button type="button", id="update-button" data-index="{{ menuitem.id }}" class="btn btn-outline-secondary btn-sm update-button">Update</button>
                            <button type="button", id="delete-button" data-index="{{ menuitem.id }}" class="btn btn-outline-secondary btn-sm delete-button">Delete</button>
                        </div>
                    </div>
                </div>

            </div>

            {% endwith %}
            {% endfor %}
            <div class="col-12 text-end">
                <div class="h3 fw-bold">
                    Sub Total: $<span id="subtotal">{{ cart.get_sub_total }}</span>
                </div>
            </div>
        </div>
    </main>
    <script>
        $(document).on("click", "#update-button", function (e) {
            e.preventDefault();
            var item_id = $(this).data('index');
            $.ajax({
                type: "POST",
                url: "{% url "cart:cart_add" %}",
                data: {
                    menuitemid: item_id,
                    menuitemqty: $("#select option:selected").val(),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    action: "post"
                },
                success: function (json) {
                    document.getElementById("cart-item-qty").innerHTML = json.qty
                    document.getElementById(item_id+"-qty").innerHTML = json.item_qty
                },
                error: function (xhr, errmsg, err) {

                }
            });

        })

        $(document).on("click", "#delete-button", function (e) {
            e.preventDefault();
            var item_id = $(this).data('index');
            $.ajax({
                type: "POST",
                url: "{% url "cart:cart_delete" %}",
                data: {
                    menuitemid: item_id,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    action: "post"
                },
                success: function (json) {
                    document.getElementById("cart-item-qty").innerHTML = json.qty
                    $('.menu-item[data-index="' + item_id + '"]').remove();
                },
                error: function (xhr, errmsg, err) {

                }
            });
        })
    </script>
{% endblock content %}
